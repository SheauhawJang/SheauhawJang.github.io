<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>麻将牌理向听数计算</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            background-color: #f9f9f9;
            padding: 40px;
            max-width: 800px;
            margin: auto;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .section {
            margin-top: 30px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .input-area {
            margin-bottom: 10px;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .placeholder-note {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        .output-box {
            background-color: #fff;
            border: 1px solid #ddd;
            border-left: 5px solid #4caf50;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }

        .output-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .output-context {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-time {
            font-size: 14px;
            color: #888;
            font-style: italic;
        }

        @media (max-width: 600px) {
            body {
                padding: 20px;
            }

            .section {
                margin-top: 15px;
            }

            h1 {
                font-size: 24px;
            }

            input[type="text"] {
                font-size: 14px;
            }

            button {
                width: 100%;
                padding: 12px;
                font-size: 14px;
            }

            .output-box {
                padding: 12px;
            }

            .output-title {
                font-size: 16px;
            }

            .output-context {
                font-size: 14px;
            }

            .output-time {
                font-size: 12px;
            }
        }
    </style>
</head>

<body>
    <h1>麻将牌理向听数计算</h1>
    <div class="section">
        <label for="inputText">请输入手牌</label>
        <div class="input-area">
            <input type="text" id="inputText" placeholder="例如：1112345678999mE" />
            <div class="placeholder-note">
                输入栏支持以下格式，以下格式可混合使用：<br />
                1.
                天凤格式：序数牌使用序数阿拉伯数字＋颜色小写字母表示，其中：<b>万=m</b>，<b>索/条=s</b>，<b>饼/筒=p</b>。字牌之<b>东南西北白发中</b>依次使用<b>1z2z3z4z5z6z7z</b>表示。同字母后缀的相邻牌可以只保留最右侧牌的字母后缀。<br />
                2. 国标小助手格式：序数牌同「天凤格式」，字牌之<b>东南西北白发中</b>依次使用大写字母<b>ESWNPFC</b>表示。<br />
                3.
                英文麻将印刷格式：序数牌同「天凤格式」，字牌之<b>东南西北</b>依次使用大写字母<b>ESWN</b>表示，<strong>白=Wh</strong>，<strong>发=G</strong>，<strong>中=R</strong>。<br />
                4. 汉语拼音格式：同天凤格式。惟<b>万=w</b>，<b>饼/筒=b</b>。
            </div>
        </div>
        <button onclick="processInput()">计算</button>
    </div>
    <div class="section">
        <div class="output-box">
            <div class="output-title">一般型牌理</div>
            <div class="output-context" id="output-std"></div>
            <div class="output-time" id="output-time-std"></div>
        </div>
        <div class="output-box">
            <div class="output-title">国标麻将标准型牌理</div>
            <div class="output-context" id="output-gb"></div>
            <div class="output-time" id="output-time-gb"></div>
        </div>
        <div class="output-box">
            <div class="output-title">立直麻将标准型牌理</div>
            <div class="output-context" id="output-jp"></div>
            <div class="output-time" id="output-time-jp"></div>
        </div>
    </div>
    <script src="mahjong.js"></script>
    <script>
        let worker = null;
        function processInput() {
            if (worker) {
                console.log("working break");
                worker.terminate();
                worker = null;
            }
            document.getElementById("output-std").innerHTML = "";
            document.getElementById("output-jp").innerHTML = "";
            document.getElementById("output-gb").innerHTML = "";
            document.getElementById("output-time-std").textContent = `Calculating......`;
            document.getElementById("output-time-jp").textContent = `Calculating......`;
            document.getElementById("output-time-gb").textContent = `Calculating......`;
            KDragonCreate();
            const input = document.getElementById("inputText").value;
            let tiles = split(input);
            let tcnt = 0;
            for (let i = 0; i < tiles.length; ++i) {
                tcnt += tiles[i];
            }
            let full_tcnt = tcnt;
            if (tcnt % 3 === 1) {
                ++full_tcnt;
            }
            worker = new Worker("mahjong-worker.js");
            let task = 0;
            let step, step13;
            worker.onmessage = function (e) {
                if ('output' in e.data) {
                    worker.last_output = e.data.output;
                    switch (task) {
                    case 0:
                        document.getElementById("output-std").innerHTML = e.data.output;
                        break;
                    case 1:
                        document.getElementById("output-jp").innerHTML = e.data.output;
                        break;
                    case 2:
                        document.getElementById("output-gb").innerHTML = e.data.output;
                        break;
                    }
                    return;
                }
                const { result, time } = e.data;
                switch (task) {
                    case 0:
                        document.getElementById("output-std").innerHTML = result.output;
                        document.getElementById("output-time-std").textContent = `Used ${time} ms`;
                        step = result.step;
                        break;
                    case 1:
                        document.getElementById("output-jp").innerHTML = result.output;
                        document.getElementById("output-time-jp").textContent = `Used ${time} ms`;
                        step13 = result.step13;
                        break;
                    case 2:
                        document.getElementById("output-gb").innerHTML = result.output;
                        document.getElementById("output-time-gb").textContent = `Used ${time} ms`;
                        break;
                }
                ++task;
                switch (task) {
                    case 0: case 1:
                        worker.postMessage({ task, tiles, tcnt, full_tcnt });
                        break;
                    case 2:
                        worker.postMessage({ task, tiles, tcnt, full_tcnt, step, step13 });
                        break;
                    case 3:
                        worker.terminate();
                        worker = null;
                }
            }
            worker.postMessage({ task, tiles, tcnt, full_tcnt });
        }
    </script>
</body>

</html>